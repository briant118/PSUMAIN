{% extends 'base.html' %}
{% load template_filters %}
{% load static %}

{% block title %}Users{% endblock %}

{% block content %}
<div class="container">

  <div class="row">
    <div class="col-md-7">
      <h4 class="mb-3">Users</h4>
      <div class="table-responsive">
        <table class="table table-striped table-hover table-sm align-middle">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>College</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for user in users %}
            <tr>
              <td>{{ user.get_full_name|default:user.username }}</td>
              <td>{{ user.email }}</td>
              <td>{{ user.profile.college.name|default:'-' }}</td>
              <td>
                <button type="button" class="btn btn-sm btn-outline-primary start-chat-btn"
                        data-recipient-email="{{ user.email }}"
                        data-recipient-name="{{ user.first_name }} {{ user.last_name }}">
                  <i class="fa-solid fa-comments"></i> Chat
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="col-md-5">
      <h4 class="mb-3">Conversations</h4>
      <table class="table table-striped table-sm" id="messagesTable">
        <thead>
          <tr>
            <th>With</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Send Initial Message Modal -->
  <div class="modal fade" id="initMessageModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content rounded-3 shadow">
        <div class="modal-header">
          <h5 class="modal-title">Send message</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="form-group mt-2">
            <label for="recipient" class="form-label">Recipient</label>
            <input type="email" id="recipient" class="form-control">
          </div>
          <div class="form-group mt-3">
            <label for="initMessage" class="form-label">Message</label>
            <textarea id="initMessage" rows="6" class="form-control"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" id="send_init_message" class="btn btn-primary"
                  data-send-init-message-url="{% url 'main_app:send-init-message' %}">
            Send
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Conversation Modal -->
  <div class="modal fade" id="conversationModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content rounded-3 shadow">
        <div class="modal-header">
          <h5 class="modal-title">Conversation with <span id="convoWith"></span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="text" id="roomId" hidden>
          <input type="email" id="receiverEmail" hidden>
          <div id="chatContainer" style="height: 350px; overflow-y: auto; border: 1px solid #ccc; border-radius: 5px; padding: 10px; background: #f9f9f9;"></div>
          <textarea id="new_message" rows="3" class="form-control mt-2" placeholder="Type a message..."></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" id="send_new_message_btn" class="btn btn-primary"
                  data-send-new-message-url="main_app:send-new-message">
            Send
          </button>
        </div>
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block scripts %}
<script>
  const currentUserId = "{{ request.user.id }}";
  let email = null;
  let chatSocket = null;
  let currentRoomId = null;

  function resetInitMessageForm() {
    $("#recipient").val("");
    $("#initMessage").val("");
  }

  function connectChatSocket(roomId) {
    // Close existing connection if any
    if (chatSocket && chatSocket.readyState !== WebSocket.CLOSED) {
      chatSocket.close();
    }
    
    currentRoomId = roomId;
    
    // Determine WebSocket protocol (ws:// or wss://)
    const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsPath = `${wsProtocol}//${window.location.host}/ws/chat/${roomId}/`;
    
    console.log("Connecting to WebSocket:", wsPath, "for room:", roomId);
    
    try {
      chatSocket = new WebSocket(wsPath);
      
      chatSocket.onopen = function(e) {
        console.log("‚úÖ WebSocket connection established for room:", roomId);
      };
      
      chatSocket.onmessage = function(e) {
        try {
          const data = JSON.parse(e.data);
          console.log("üì® WebSocket message received:", data);
          
          // Verify message is for the current room
          if (data.room_id && String(data.room_id) !== String(roomId)) {
            console.warn(`‚ö†Ô∏è Message room_id (${data.room_id}) doesn't match current room (${roomId}), ignoring`);
            return;
          }
          
          if (data.type === "new_message") {
            console.log("Processing new_message type");
            handleNewMessage(data);
          } else if (data.type === "message_read") {
            console.log("Message read notification:", data);
          } else {
            console.log("Unknown message type:", data.type);
          }
        } catch (error) {
          console.error("‚ùå Error parsing WebSocket message:", error, "Raw data:", e.data);
        }
      };
      
      chatSocket.onerror = function(e) {
        console.error("‚ùå WebSocket error:", e);
        console.error("WebSocket readyState:", chatSocket.readyState);
      };
      
      chatSocket.onclose = function(e) {
        console.log("üîå WebSocket connection closed for room:", roomId, "Code:", e.code, "Reason:", e.reason);
        // Attempt to reconnect after 3 seconds if it wasn't a manual close
        if (currentRoomId === roomId && e.code !== 1000) {
          setTimeout(function() {
            if (currentRoomId === roomId && (chatSocket === null || chatSocket.readyState === WebSocket.CLOSED)) {
              console.log("üîÑ Attempting to reconnect WebSocket...");
              connectChatSocket(roomId);
            }
          }, 3000);
        }
      };
    } catch (error) {
      console.error("‚ùå Error creating WebSocket:", error);
    }
  }

  function disconnectChatSocket() {
    console.log("Disconnecting WebSocket");
    if (chatSocket) {
      chatSocket.close();
      chatSocket = null;
      currentRoomId = null;
    }
    window.currentOpenRoomId = null;
  }

  function handleNewMessage(data) {
    console.log("=== handleNewMessage START ===");
    console.log("Message data:", data);
    console.log("Current user ID:", currentUserId);
    console.log("Current open room ID:", window.currentOpenRoomId);
    
    const chatContainer = $("#chatContainer");
    const modal = $("#conversationModal");
    console.log("chatContainer found:", chatContainer.length > 0);
    console.log("Modal element found:", modal.length > 0);
    console.log("Modal has 'show' class:", modal.hasClass('show'));
    console.log("Modal visible:", modal.is(':visible'));
    
    // Verify room ID matches
    if (data.room_id && window.currentOpenRoomId && String(data.room_id) !== String(window.currentOpenRoomId)) {
      console.warn(`‚ö†Ô∏è Message room_id (${data.room_id}) doesn't match current open room (${window.currentOpenRoomId}), ignoring`);
      return;
    }
    
    const isSender = String(currentUserId) == String(data.sender_id);
    const isRecipient = String(currentUserId) == String(data.recipient_id);
    
    console.log(`Sender ID: ${data.sender_id}, Recipient ID: ${data.recipient_id}`);
    console.log(`isSender: ${isSender}, isRecipient: ${isRecipient}`);
    
    // Only add message if it belongs to the current user
    if (!isSender && !isRecipient) {
      console.log("‚ö†Ô∏è Message doesn't belong to current user, ignoring");
      return;
    }
    
    // Only add to chat container if modal is open
    if (chatContainer.length === 0) {
      console.warn("‚ö†Ô∏è chatContainer not found - modal might be closed");
      // Still update the conversation list
      loadMessages();
      return;
    }
    
    // Verify the room ID matches what we expect
    const currentRoomIdFromInput = $("#roomId").val();
    if (currentRoomIdFromInput && String(currentRoomIdFromInput) !== String(window.currentOpenRoomId)) {
      console.warn(`‚ö†Ô∏è Room ID mismatch - input (${currentRoomIdFromInput}) vs open room (${window.currentOpenRoomId})`);
      // Still update the conversation list
      loadMessages();
      return;
    }
    
    // Check if modal is open (use Bootstrap's modal instance check)
    const modal = $("#conversationModal");
    const isModalVisible = modal.length > 0 && (modal.hasClass('show') || modal.is(':visible'));
    if (!isModalVisible) {
      console.warn("‚ö†Ô∏è Modal not visible - will not display message");
      console.log("Modal element:", modal.length > 0 ? "found" : "not found");
      console.log("Modal has 'show' class:", modal.hasClass('show'));
      console.log("Modal is visible:", modal.is(':visible'));
      // Still update the conversation list
      loadMessages();
      return;
    }
    
    // Check if message already exists (avoid duplicates)
    if (data.chat_id) {
      const existingMessages = chatContainer.find(`[data-chat-id="${data.chat_id}"]`);
      if (existingMessages.length > 0) {
        console.log("‚ö†Ô∏è Message already displayed, skipping duplicate");
        loadMessages();
        return;
      }
    }
    
    // Remove any temp message with same content
    chatContainer.find(`[data-temp-message]`).remove();
    
    // Remove "No messages" placeholder if it exists
    chatContainer.find('.text-muted').remove();
    
    // Add the message
    if (isSender) {
      const messageHtml = `<div class="message sender" data-chat-id="${data.chat_id || 'temp_' + Date.now()}" style="background:#DCF8C6; border-radius:12px; padding:8px 12px; margin:5px 0; max-width:70%; align-self:flex-start;"><span style="font-size: small;">You</span><br>${data.message}</div>`;
      chatContainer.append(messageHtml);
      console.log("‚úÖ Added sender message to chat");
    } else {
      const senderName = data.sender_first_name || data.sender_last_name || 'Staff';
      const messageHtml = `<div class="message receiver" data-chat-id="${data.chat_id || 'temp_' + Date.now()}" style="background:#E5E5EA; border-radius:12px; padding:8px 12px; margin:5px 0; max-width:70%; align-self:flex-end;"><span style="font-size: small;">${senderName}</span><br>${data.message}</div>`;
      chatContainer.append(messageHtml);
      console.log("‚úÖ Added receiver message to chat");
    }
    
    chatContainer.scrollTop(chatContainer.prop("scrollHeight"));
    console.log("=== handleNewMessage END ===");
    
    // Update unread indicators if needed
    loadMessages();
  }

  function loadMessages() {
    const messagesBody = $("#messagesTable tbody");
    $.ajax({
      url: "/ajax/load-messages",
      method: "GET",
      success: function (data) {
        messagesBody.empty();
        let seen = new Set();
        $.each(data.result, function (index, room) {
          const other = (currentUserId == room.receiver.id) ? room.initiator : room.receiver;
          const otherKey = `${other.id}-${room.id}`;
          if (seen.has(otherKey)) return;
          seen.add(otherKey);
          let row = `<tr class="messagesItem"
                        data-room-id=${room.id}
                        data-receiver-email=${other.email}
                        data-receiver-fname=${other.first_name}
                        data-receiver-lname=${other.last_name}>
                        <td>${other.first_name} ${other.last_name}</td>
                    </tr>`;
          if (room.chats && room.chats.some(chat => chat.status === "sent" && chat.sender != currentUserId && chat.recipient == currentUserId)) {
            row = $(row).addClass("text-primary");
          }
          messagesBody.append(row);
        });
      }
    });
  }

  function loadConversation(roomId) {
    const chatContainer = $("#chatContainer");
    console.log("Loading conversation for room:", roomId);
    console.log("chatContainer found:", chatContainer.length > 0);
    console.log("Current user ID:", currentUserId);
    
    // Store the room ID globally so handleNewMessage can verify
    window.currentOpenRoomId = roomId;
    
    // Connect to WebSocket for real-time updates FIRST
    // This ensures we receive messages even during AJAX loading
    connectChatSocket(roomId);
    
    // Load existing messages via AJAX
    $.ajax({ url: `/ajax/load-conversation/${roomId}/`, method: "GET", success: function(data) {
      console.log("loadConversation response:", data);
      
      // Check if container still exists (modal might have been closed)
      if (chatContainer.length === 0) {
        console.warn("chatContainer no longer exists, aborting");
        return;
      }
      
      chatContainer.empty();
      if (data.result && data.result.length > 0) {
        $.each(data.result, function(index, msg) {
          // Ensure the message belongs to the current user (as sender or recipient)
          if (String(currentUserId) == String(msg.sender__id) || String(currentUserId) == String(msg.recipient__id)) {
            // Use chat ID if available, otherwise use index
            const chatId = msg.id || `msg_${index}`;
            if (String(currentUserId) == String(msg.sender__id)) {
              chatContainer.append(`<div class="message sender" data-chat-id="${chatId}" style="background:#DCF8C6; border-radius:12px; padding:8px 12px; margin:5px 0; max-width:70%; align-self:flex-start;"><span style="font-size: small;">You</span><br>${msg.message}</div>`);
            } else {
              chatContainer.append(`<div class="message receiver" data-chat-id="${chatId}" style="background:#E5E5EA; border-radius:12px; padding:8px 12px; margin:5px 0; max-width:70%; align-self:flex-end;"><span style="font-size: small;">${msg.sender__first_name || 'Staff'}</span><br>${msg.message}</div>`);
            }
          }
        });
        chatContainer.scrollTop(chatContainer.prop("scrollHeight"));
      } else {
        chatContainer.append('<div class="text-muted">No messages in this conversation yet.</div>');
      }
    }, error: function(xhr) {
      console.error("Error loading conversation:", xhr);
      if (chatContainer.length > 0) {
        chatContainer.append('<div class="text-danger">Error loading conversation. Please refresh the page.</div>');
      }
      if (xhr.responseJSON && xhr.responseJSON.error) {
        alert("Error: " + xhr.responseJSON.error);
      }
    }});
  }

  $(document).ready(function () {
    loadMessages();
    
    // Close WebSocket when modal is closed
    $(document).on('hidden.bs.modal', '#conversationModal', function () {
      disconnectChatSocket();
    });

    // Open init chat modal from Users table
    $(document).on('click', '.start-chat-btn', function () {
      const recipientEmail = $(this).data('recipient-email');
      $("#recipient").val(recipientEmail).prop("disabled", true);
      $("#initMessageModal").modal("show");
    });

    // Send initial message
    $("#send_init_message").click(function () {
      let recipient = $("#recipient").val();
      let initMessage = $("#initMessage").val();
      if (!initMessage) { alert("Message cannot be empty."); return; }
      $.ajax({
        url: $(this).data("send-init-message-url"),
        type: "POST",
        data: { recipient: recipient, message: initMessage },
        beforeSend: function(xhr) {
          xhr.setRequestHeader("X-CSRFToken", $('[name=csrfmiddlewaretoken]').val() || document.querySelector('[name=csrfmiddlewaretoken]')?.value || '');
        },
        success: function () {
          $("#initMessageModal").modal("hide");
          resetInitMessageForm();
          loadMessages();
        },
        error: function (xhr) {
          let errorMsg = "Failed to send message.";
          if (xhr.responseJSON && xhr.responseJSON.error) {
            errorMsg = xhr.responseJSON.error;
          } else if (xhr.responseText) {
            try {
              const errorData = JSON.parse(xhr.responseText);
              errorMsg = errorData.error || errorMsg;
            } catch(e) {
              errorMsg = xhr.responseText.substring(0, 100);
            }
          }
          alert("Error: " + errorMsg);
        }
      });
    });

    // Open conversation modal from list
    $(document).on("click", ".messagesItem", function () {
      var roomId = $(this).data('room-id');
      var receiverEmail = $(this).data('receiver-email');
      var receiverFirstname = $(this).data("receiver-fname");
      var receiverLastname = $(this).data("receiver-lname");
      $("#receiverEmail").val(receiverEmail);
      $("#roomId").val(roomId);
      $("#convoWith").text(receiverFirstname + ' ' + receiverLastname);
      
      // Show modal first
      var modalEl = document.getElementById('conversationModal');
      if (modalEl) {
        var modal = new bootstrap.Modal(modalEl);
        modal.show();
        
        // Wait for modal to be fully shown before loading conversation and connecting WebSocket
        modalEl.addEventListener('shown.bs.modal', function onShown() {
          console.log("Modal shown, loading conversation for room:", roomId);
          loadConversation(roomId);
          // Remove listener after first use
          modalEl.removeEventListener('shown.bs.modal', onShown);
        }, { once: true });
      } else {
        // Fallback to jQuery if Bootstrap 5 not available
        $("#conversationModal").modal("show");
        $("#conversationModal").one('shown.bs.modal', function() {
          loadConversation(roomId);
        });
      }
    });

    // Send new message
    $("#send_new_message_btn").click(function () {
      let newMessage = $("#new_message").val();
      let roomId = $("#roomId").val();
      if (!newMessage) return;
      let completeUrl = `/ajax/send-new-message/${roomId}/`;
      $.ajax({ 
        url: completeUrl, 
        type: "POST", 
        data: { message: newMessage },
        beforeSend: function(xhr) {
          xhr.setRequestHeader("X-CSRFToken", $('[name=csrfmiddlewaretoken]').val() || document.querySelector('[name=csrfmiddlewaretoken]')?.value || '');
        },
        success: function (response) {
          // Message will be added via WebSocket, but we add it optimistically
          // The WebSocket handler will prevent duplicates
          const chatContainer = $("#chatContainer");
          // Only add if not already added by WebSocket
          if (!chatContainer.find(`[data-temp-message="${newMessage}"]`).length) {
            chatContainer.append(`<div class="message sender" data-temp-message="${newMessage}" style="background:#DCF8C6; border-radius:12px; padding:8px 12px; margin:5px 0; max-width:70%; align-self:flex-start;"><span style="font-size: small;">You</span><br>${newMessage}</div>`);
            chatContainer.scrollTop(chatContainer.prop("scrollHeight"));
          }
          $("#new_message").val("");
          loadMessages(); // Refresh conversation list for unread indicators
        },
        error: function (xhr) {
          let errorMsg = "Failed to send message.";
          if (xhr.responseJSON && xhr.responseJSON.error) {
            errorMsg = xhr.responseJSON.error;
          } else if (xhr.responseText) {
            try {
              const errorData = JSON.parse(xhr.responseText);
              errorMsg = errorData.error || errorMsg;
            } catch(e) {
              errorMsg = xhr.responseText.substring(0, 100);
            }
          }
          alert("Error: " + errorMsg);
        }
      });
    });
  });
</script>
{% endblock %}
