{% extends "base.html" %}
{% load static %}

{% block title %}Complete Your Profile{% endblock %}

{% block links %}
<style>
  .main-content {
    margin-left: 0 !important;
    width: 100% !important;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
  }
  #content {
    padding: 0 !important;
    width: 100%;
  }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5 pt-5 rounded">
  <div class="card col-md-6 offset-md-3 border rounded shadow-lg mb-5 bg-body">
    <div class="text-center card-body bg-success text-white mb-3">
      <div class="mb-3">
        {% if user.profile.profile_picture %}
          <img src="{{ user.profile.profile_picture.url }}" class="rounded-circle" alt="Profile Picture" style="width: 80px; height: 80px; object-fit: cover; border: 3px solid white;">
        {% else %}
          <div class="bg-white rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 80px; height: 80px; border: 3px solid white;">
            <i class="fa-solid fa-user fa-2x text-success"></i>
          </div>
        {% endif %}
      </div>
      <h1>Welcome, {{ user.first_name|default:user.email }}!</h1>
      <p class="mb-0">Please complete your profile to continue</p>
    </div>
    <div class="form-section card-body p-4">
      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}
      
      <form method="post" id="profileForm">
        {% csrf_token %}
        
        <!-- Step 1: Role Selection -->
        <div class="step active" id="step1">
          <h3 class="mb-4">Select your role</h3>
          <div class="text-center">
            <button type="button" class="btn btn-outline-primary btn-lg me-3 mb-3" 
                    onclick="selectRole('student')" id="btn-student">
              <i class="fa-solid fa-user-graduate"></i><br>
              Student
            </button>
            <button type="button" class="btn btn-outline-primary btn-lg me-3 mb-3" 
                    onclick="selectRole('faculty')" id="btn-faculty">
              <i class="fa-solid fa-chalkboard-user"></i><br>
              Faculty
            </button>
            <button type="button" class="btn btn-outline-primary btn-lg mb-3" 
                    onclick="selectRole('staff')" id="btn-staff">
              <i class="fa-solid fa-user-tie"></i><br>
              Staff
            </button>
          </div>
          <input type="hidden" name="role" id="role" required>
        </div>

        <!-- Step 2: College Selection -->
        <div class="step" id="step2" style="display: none;">
          <h3 class="mb-4">Select your college</h3>
          <select name="college" id="college" required class="form-control form-control-lg mb-3">
            <option value="">-- Select College --</option>
            {% for college in colleges %}
            <option value="{{ college.id }}">{{ college.name }}</option>
            {% endfor %}
          </select>
          
          <!-- Student-specific fields -->
          <div id="student-fields" style="display: none;">
            <input type="text" name="course" placeholder="Course Name (e.g., BSIT)" 
                   class="form-control mb-2">
            <input type="text" name="year" placeholder="Year (e.g., 3rd Year)" 
                   class="form-control mb-2">
            <input type="text" name="block" placeholder="Block (e.g., 2A)" 
                   class="form-control mb-2">
          </div>
          
          <!-- School ID (if not PSU email) -->
          {% if not user.email|slice:":-22" %}
          <div class="mb-3">
            <label for="school_id" class="form-label">School ID (Optional)</label>
            <input type="text" name="school_id" id="school_id" 
                   placeholder="Your school ID" class="form-control">
          </div>
          {% endif %}
          
          <div class="d-flex justify-content-between mt-4">
            <button type="button" class="btn btn-secondary" onclick="goToStep(1)">Back</button>
            <button type="submit" class="btn btn-success">Complete Profile</button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function selectRole(role) {
  // Update hidden input
  document.getElementById('role').value = role;
  
  // Update button styles
  document.querySelectorAll('[id^="btn-"]').forEach(btn => {
    btn.classList.remove('btn-primary');
    btn.classList.add('btn-outline-primary');
  });
  
  const selectedBtn = document.getElementById('btn-' + role);
  selectedBtn.classList.remove('btn-outline-primary');
  selectedBtn.classList.add('btn-primary');
  
  // Show/hide student fields
  const studentFields = document.getElementById('student-fields');
  if (role === 'student') {
    studentFields.style.display = 'block';
    // Make student fields required
    studentFields.querySelectorAll('input').forEach(input => {
      input.setAttribute('required', 'required');
    });
  } else {
    studentFields.style.display = 'none';
    // Remove required from student fields
    studentFields.querySelectorAll('input').forEach(input => {
      input.removeAttribute('required');
    });
  }
  
  // Move to next step after a short delay
  setTimeout(() => {
    goToStep(2);
  }, 300);
}

function goToStep(stepNum) {
  // Hide all steps
  document.querySelectorAll('.step').forEach(step => {
    step.style.display = 'none';
  });
  
  // Show current step
  const currentStep = document.getElementById('step' + stepNum);
  if (currentStep) {
    currentStep.style.display = 'block';
  }
}

// Form validation
document.getElementById('profileForm').addEventListener('submit', function(e) {
  const role = document.getElementById('role').value;
  const college = document.getElementById('college').value;
  
  if (!role) {
    e.preventDefault();
    alert('Please select your role');
    goToStep(1);
    return false;
  }
  
  if (!college) {
    e.preventDefault();
    alert('Please select your college');
    goToStep(2);
    return false;
  }
  
  if (role === 'student') {
    const course = document.querySelector('input[name="course"]').value;
    const year = document.querySelector('input[name="year"]').value;
    const block = document.querySelector('input[name="block"]').value;
    
    if (!course || !year || !block) {
      e.preventDefault();
      alert('Please fill in all student fields (Course, Year, Block)');
      goToStep(2);
      return false;
    }
  }
  
  return true;
});
</script>
{% endblock %}

